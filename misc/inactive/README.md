# Deleting inactive devices

Notes on how this works...

### /my_network.htm
The page listing the known network devices; contains a value for pi and some other vars

```
<meta name="pi" content="28Xt37r1077bM3N4">

<script language="JavaScript" type="text/javascript">
       var CGIs = ["myNetwork","owl"];
</script>

<script src="./nonAuth/globals.js"></script>
```

### /nonAuth/globals.js

#### what is pi?

it seems to be something that ties up the values generated by the cgis at that timestamp?
```
function renew_CGI_pi()
	
change_pi_var = new HTTP_Request(change_pi);
change_pi_var.request("cgi/renewPi.js", "GET");
	//renew cgi
	var s,k;
	CA=[];
	for(var i=0; i < CGIs.length;i++){
		k="cgi/cgi_"+CGIs[i]+'.js?t='+ Date.now();
		
```

#### URL encoding

```
// our CFG items use ";" as delimiter, it is not suitable for javascrip
// we need conver it to "%3B" from CFG_CGI routing if it is string conent
// also embedded inside CFG field.
// we also need conver to into "%3B" if want to setCfg().
// here use str2HTML() to conver to back, but some special operator like
// ":",".",",","-" can not be convert due to multi-fields CFG item use it
// as delimiter. ":" for MAC, "." for IP, "-" for range, "," for multi-range

function deleteDev(order, j, device){
...     
setCfg("known_devices_update", "d," + devicesList_Iface[order].getMac(j) + ";");
sendForm("my_network.htm", "", "");
...
}

function sendForm(cPage, _cmd, _waiting){
        var url ="/apply.cgi";
        xmlhttp.open("POST", url, true);
        var params = "CMD="+_cmd+ "&GO="+cPage;

        for (var i=0;i<CA.length;i++){
                if (CA[i].v!=CA[i].o){
                        temp = setCfg(CA[i].n, CA[i].v)
                        params = params + "&SET" + sub + "=" + String(CA[i].i) + "%3D"+ temp;
                        sub++;
                }
        }
```

so globals.js calls the CGI's listed in /my_network.htm eg:

```
/cgi/cgi_myNetwork.js?t=1592032536131
/cgi/cgi_owl.js?t=1592032536131
```

### /cgi/cgi_myNetwork.js

contains the known_devices_update cfg var we need and a variable known_device_list which seems to be the list of all known macs

```
var known_device_list=[{mac:'0A%3AB2%3A02%3A7E%3A59%3AD1'
addCfg("known_devices_update",94717334,'');
```

cgi_owl.js doesn't really seem to be required but maybe it has a unique cfg value 


### /apply.cgi

```
Origin: http://ipofsmarthub
CMD=&GO=my_network.htm&SET0=53813335%3Dd%252C7C%253AFF%253A48%253A70%253A8D%253A8A%253B&pi=IANp88wHLhou6PA3

CMD=&GO=my_network.htm&SET0= 53813335 %3D d%252C 7C %253A FF %253A 48 %253A 70 %253A 8D %253A 8A %253B  &pi=IANp88wHLhou6PA3'
'''

* '#3D' included in sendForm
* 53813335 = known_devices_update value from cgi_myNetwork
* 'd%252C' = 'd%2C' = "d," from deleteDev
* '%253A' = '%3A' = : in mac addresses
* '%253B' = '%3B' = ; ( end of command? ) 
